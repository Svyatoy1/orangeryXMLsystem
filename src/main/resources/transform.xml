<?xml version="1.0" encoding="UTF-8"?>

<xsl:stylesheet version="1.0"
                xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <xsl:output method="xml" indent="yes"/>

    <xsl:key name="flowersBySoil" match="flower" use="soil"/>

    <xsl:template match="/">
        <groupedFlowers>
            <!-- беремо унікальні значення soil -->
            <xsl:for-each select="flowers/flower[generate-id() = generate-id(key('flowersBySoil', soil)[1])]">
                <soilGroup type="{soil}">
                    <!-- вставляємо всі flower з таким soil -->
                    <xsl:for-each select="key('flowersBySoil', soil)">
                        <xsl:copy-of select="."/>
                    </xsl:for-each>
                </soilGroup>
            </xsl:for-each>
        </groupedFlowers>
    </xsl:template>

</xsl:stylesheet>